{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>üèõÔ∏è Temple Management Dashboard</h2>
        <p class="text-muted">Manage daily bookings and verify QR codes</p>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <h4>{{ today_bookings|length }}</h4>
                <p class="mb-0">Today's Bookings</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4>‚Çπ{{ today_revenue }}</h4>
                <p class="mb-0">Today's Revenue</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <h4>{{ pending_orders }}</h4>
                <p class="mb-0">Pending Orders</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4>{{ collected_orders }}</h4>
                <p class="mb-0">Collected Orders</p>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Section -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="bi bi-qr-code-scan"></i> Quick QR Scanner</h5>
            </div>
            <div class="card-body">
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="quickQR" placeholder="Scan QR code here">
                    <button class="btn btn-primary" id="quickScanBtn">Verify</button>
                </div>
                <div id="quickResult" class="mt-3"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="bi bi-clock"></i> Live Updates</h5>
            </div>
            <div class="card-body">
                <div id="liveUpdates">
                    <p class="text-muted">Waiting for new bookings...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Today's Bookings -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>üìÖ Today's Bookings</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Customer</th>
                                <th>Temple</th>
                                <th>Slot</th>
                                <th>Persons</th>
                                <th>QR Code</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for booking in today_bookings %}
                            <tr>
                                <td>{{ booking.created_at.strftime('%H:%M') }}</td>
                                <td>{{ booking.user.name }}</td>
                                <td>{{ booking.temple.name }}</td>
                                <td>{{ booking.time_slot }}</td>
                                <td>{{ booking.persons }}</td>
                                <td>
                                    {% for order in booking.orders %}
                                        {% if order.qr_code %}
                                        <div class="d-flex align-items-center">
                                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=50x50&data={{ order.qr_code }}" alt="QR" class="me-2">
                                            <small>{{ order.qr_code }}</small>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">No services</span>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for order in booking.orders %}
                                    <span class="badge bg-{{ 'success' if order.status == 'collected' else 'warning' }}">
                                        {{ order.status.title() }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">Darshan Only</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    {% for order in booking.orders %}
                                        {% if order.status == 'pending' %}
                                        <button class="btn btn-sm btn-success collect-btn" data-order-id="{{ order.id }}">
                                            <i class="bi bi-check"></i> Collect
                                        </button>
                                        {% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Order details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
// Quick QR Scanner
document.getElementById('quickScanBtn').addEventListener('click', quickScan);
document.getElementById('quickQR').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') quickScan();
});

function quickScan() {
    const qrCode = document.getElementById('quickQR').value.trim();
    if (!qrCode) return;
    
    fetch('/api/verify-qr', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({qr_code: qrCode})
    })
    .then(response => response.json())
    .then(data => {
        const resultDiv = document.getElementById('quickResult');
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <h6>‚úÖ Valid Order</h6>
                    <p><strong>Customer:</strong> ${data.user_name}</p>
                    <p><strong>Temple:</strong> ${data.temple_name}</p>
                    <p><strong>Amount:</strong> ‚Çπ${data.total_amount}</p>
                    <p><strong>Status:</strong> ${data.status.toUpperCase()}</p>
                    ${data.status === 'pending' ? 
                        `<button class="btn btn-success btn-sm" onclick="collectOrder(${data.order_id})">Mark as Collected</button>` : 
                        '<span class="badge bg-success">Already Collected</span>'
                    }
                </div>
            `;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${data.error}</div>`;
        }
        document.getElementById('quickQR').value = '';
    });
}

// Collect order function
function collectOrder(orderId) {
    fetch('/api/collect-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({order_id: orderId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Order collected successfully!');
            location.reload();
        } else {
            alert('‚ùå Error: ' + data.error);
        }
    });
}

// Collect buttons
document.querySelectorAll('.collect-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const orderId = this.dataset.orderId;
        if (confirm('Mark this order as collected?')) {
            collectOrder(orderId);
        }
    });
});

// Auto-refresh every 30 seconds
setInterval(() => {
    location.reload();
}, 30000);

// Live updates via WebSocket
const socket = io();
socket.on('new_booking', function(data) {
    const liveDiv = document.getElementById('liveUpdates');
    liveDiv.innerHTML = `
        <div class="alert alert-info">
            <strong>üÜï New Booking!</strong><br>
            ${data.user} booked ${data.temple}<br>
            Time: ${data.time_slot} | Persons: ${data.persons}
            ${data.qr_code ? `<br>QR: ${data.qr_code}` : ''}
        </div>
    `;
    
    // Auto-refresh after 3 seconds
    setTimeout(() => location.reload(), 3000);
});
</script>
{% endblock %}